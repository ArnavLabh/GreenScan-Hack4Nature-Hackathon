{% extends "base.html" %}

{% block title %}Scan - GreenScan{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-body p-4">
                    <h2 class="text-center mb-4">Scan Barcode</h2>
                    
                    <div class="text-center mb-4">
                        <div id="camera-container" class="mb-3" style="display: none;">
                            <video id="camera" class="img-fluid rounded" style="max-height: 400px;"></video>
                        </div>
                        <div id="loading" class="text-center" style="display: none;">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Processing image...</p>
                        </div>
                        <div id="error-message" class="alert alert-danger" style="display: none;"></div>
                    </div>

                    <div class="d-flex justify-content-center gap-2 mb-4">
                        <button id="startCamera" class="btn btn-success">
                            <i class="fas fa-camera me-2"></i>Start Camera
                        </button>
                        <button id="captureImage" class="btn btn-primary" style="display: none;">
                            <i class="fas fa-camera-retro me-2"></i>Capture
                        </button>
                        <button id="uploadImage" class="btn btn-warning">
                            <i class="fas fa-upload me-2"></i>Upload Image
                        </button>
                        <input type="file" id="imageInput" accept="image/*" style="display: none;">
                    </div>

                    <div class="text-center">
                        <p class="text-muted">Or enter barcode manually:</p>
                        <form id="barcodeForm" method="POST" action="{{ url_for('main.result') }}" class="d-flex justify-content-center gap-2">
                            <input type="text" name="barcode" id="barcode" class="form-control" style="max-width: 200px;" 
                                   pattern="[0-9]+" required placeholder="Enter barcode">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-search me-2"></i>Search
                            </button>
                        </form>
                    </div>

                    <div class="mt-4">
                        <h5 class="text-center mb-3">Scanning Tips</h5>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="text-center">
                                    <i class="fas fa-lightbulb text-warning fa-2x mb-2"></i>
                                    <p class="mb-0">Ensure good lighting</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center">
                                    <i class="fas fa-hand-paper text-info fa-2x mb-2"></i>
                                    <p class="mb-0">Hold steady</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center">
                                    <i class="fas fa-barcode text-success fa-2x mb-2"></i>
                                    <p class="mb-0">Focus on barcode</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
let html5QrCode = null;

document.addEventListener('DOMContentLoaded', function() {
    const startCameraBtn = document.getElementById('startCamera');
    const captureImageBtn = document.getElementById('captureImage');
    const uploadImageBtn = document.getElementById('uploadImage');
    const imageInput = document.getElementById('imageInput');
    const cameraContainer = document.getElementById('camera-container');
    const camera = document.getElementById('camera');
    const loading = document.getElementById('loading');
    const errorMessage = document.getElementById('error-message');
    const barcodeForm = document.getElementById('barcodeForm');

    // Initialize QR code scanner once
    function initializeScanner() {
        if (html5QrCode === null) {
            html5QrCode = new Html5Qrcode("camera-container");
        }
        return html5QrCode;
    }

    startCameraBtn.addEventListener('click', async function() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                } 
            });
            camera.srcObject = stream;
            cameraContainer.style.display = 'block';
            startCameraBtn.style.display = 'none';
            captureImageBtn.style.display = 'inline-block';
            
            // Initialize QR code scanner
            const scanner = initializeScanner();
            scanner.start(
                { deviceId: stream.getVideoTracks()[0].getSettings().deviceId },
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 },
                    formatsToSupport: [
                        Html5QrcodeSupportedFormats.EAN_13,
                        Html5QrcodeSupportedFormats.UPC_A,
                        Html5QrcodeSupportedFormats.UPC_E,
                        Html5QrcodeSupportedFormats.EAN_8,
                        Html5QrcodeSupportedFormats.CODE_128,
                        Html5QrcodeSupportedFormats.CODE_39,
                        Html5QrcodeSupportedFormats.CODABAR
                    ]
                },
                onScanSuccess,
                onScanFailure
            );
        } catch (err) {
            showError('Error accessing camera: ' + err.message);
        }
    });

    function onScanSuccess(decodedText) {
        if (html5QrCode) {
            html5QrCode.stop();
        }
        document.getElementById('barcode').value = decodedText;
        barcodeForm.submit();
    }

    function onScanFailure(error) {
        // Handle scan failure silently
        console.warn(`QR code scan failed: ${error}`);
    }

    captureImageBtn.addEventListener('click', function() {
        const canvas = document.createElement('canvas');
        canvas.width = camera.videoWidth;
        canvas.height = camera.videoHeight;
        canvas.getContext('2d').drawImage(camera, 0, 0);
        
        canvas.toBlob(function(blob) {
            processImage(blob);
        }, 'image/jpeg', 0.8); // Reduced quality for faster processing
    });

    uploadImageBtn.addEventListener('click', function() {
        imageInput.click();
    });

    imageInput.addEventListener('change', function(e) {
        if (e.target.files && e.target.files[0]) {
            processImage(e.target.files[0]);
        }
    });

    function processImage(file) {
        loading.style.display = 'block';
        errorMessage.style.display = 'none';
        
        // Stop any ongoing scanning
        if (html5QrCode) {
            html5QrCode.stop();
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                // Resize image if too large
                const maxSize = 1024; // Maximum dimension
                let width = img.width;
                let height = img.height;
                
                if (width > maxSize || height > maxSize) {
                    if (width > height) {
                        height = Math.round((height * maxSize) / width);
                        width = maxSize;
                    } else {
                        width = Math.round((width * maxSize) / height);
                        height = maxSize;
                    }
                }

                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                // Try to decode barcode
                const scanner = initializeScanner();
                scanner.scanFile(canvas.toDataURL('image/jpeg', 0.8), true)
                    .then(decodedText => {
                        document.getElementById('barcode').value = decodedText;
                        barcodeForm.submit();
                    })
                    .catch(err => {
                        showError('No barcode found in image. Please try again.');
                    })
                    .finally(() => {
                        loading.style.display = 'none';
                    });
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
        loading.style.display = 'none';
    }

    // Cleanup when leaving the page
    window.addEventListener('beforeunload', function() {
        if (html5QrCode) {
            html5QrCode.stop();
        }
        if (camera.srcObject) {
            camera.srcObject.getTracks().forEach(track => track.stop());
        }
    });
});
</script>
{% endblock %}